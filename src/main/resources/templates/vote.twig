{% extends "base.twig" %}
{% block pageTitle %}Voteaza filmele{% endblock %}
{% block stylesheets %}
    <style>
        .ui-slider-handle {
            width: 2em !important;
            height: 1.5em !important;
            top: 50%;
            text-align: center;
            line-height: 1.6em;
        }
    </style>
{% endblock %}

{% block javascripts %}
    <script>
        $('#timeAlert').hide();
        $(function () {
            $(".slider").slider({
                min: 0,
                max: 100,
                value: $(this).attr('data-rating'),
                create: function () {
                    $(this).slider('value', $(this).attr('data-rating'));
                    $('.ui-slider-handle[data-movie-id="' + $(this).attr('data-movie-id') + '"]').text($(this).slider("value"));
                },
                slide: function (event, ui) {
                    $(this).attr('data-rating', ui.value);
                    $('.ui-slider-handle[data-movie-id="' + $(this).attr('data-movie-id') + '"]').text(ui.value);
                },
                stop: function (event, ui) {
                    let movieId = $(this).attr('data-movie-id');

                    $.ajax({
                        type: "PUT",
                        url: '/vote/' + encodeURIComponent(movieId) + '/' + ui.value,
                        success: function (data) {
                            if (data.status !== 200) {
                                alert('[' + data.status + '] ' + data.message);
                            }
                        },
                        error: function (data) {
                            alert('[' + data.status + '] ' + data.message);
                        }
                    });
                }
            });
        });

        (function () {
            let start = new Date;
            start.setDate(10);
            start.setHours(23, 0, 0); // 11pm

            function pad(num) {
                return ("0" + parseInt(num)).substr(-2);
            }

            function tick() {
                let now = new Date;
                if (now > start) { // too late, go to tomorrow
                    start.setDate(start.getDate() + 1);
                }
                let remain = ((start - now) / 1000);
                let hh = pad((remain / 60 / 60) % 60);
                let mm = pad((remain / 60) % 60);
                let ss = pad(remain % 60);
                document.getElementById('time').innerHTML =
                    hh + " ore " + mm + " minute " + ss + " secunde";
                setTimeout(tick, 1000);

                if (hh > 24) {
                    $('#timeAlert').hide();
                } else {
                    $('#timeAlert').show();
                }
            }

            document.addEventListener('DOMContentLoaded', tick);
        })();
    </script>
{% endblock %}

{% block body %}
    <div class="container-fluid">
        <div class="row mt-2">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> Votul se salveaza automat in momentul in care se face slide!
                </div>
            </div>
        </div>

        <div class="row" id="timeAlert">
            <div class="col-12">
                <div class="alert alert-danger">
                    Grabeste-te!!! Timp ramas: <span id='time'></span>
                </div>
            </div>
        </div>

        {% for movie in movies %}
            <div class="row border-bottom border-top border-dark">
                <div class="col-3 p-0 my-auto">
                    <img src="https://image.tmdb.org/t/p/w200{{ movie.posterPath }}" class="img-fluid"
                         alt="logo_{{ movie.title }}">
                </div>
                <div class="col-9">
                    <strong>{{ movie.title }}</strong>
                    <br>
                    <small>
                        <strong>Nota iMDB: </strong>
                    </small>
                    <span class="badge badge-warning"><i class="fas fa-star-half-alt"></i> {{ movie.rating }}</span>
                    <br>
                    <small>
                        <strong>Propus de: </strong> {{ movie.user.username }}
                    </small>
                    <br>
                    <small>
                        <strong>Genuri: </strong>

                    </small>
                    <hr class="p-0 m-0 my-1">
                    <div class="row">
                        <div class="col-1 p-0 pl-1">
                            <i class="far fa-thumbs-down"></i>
                        </div>
                        <div class="col-10 p-0 pl-1 pt-1">
                            <div class="slider" data-movie-id="{{ movie.id }}"
                                 data-rating="{{ ratings[movie.id].rating }}">
                                <div class="ui-slider-handle" data-movie-id="{{ movie.id }}"></div>
                            </div>
                        </div>
                        <div class="col-1 p-0 pl-1">
                            <i class="far fa-grin-hearts"></i>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}
